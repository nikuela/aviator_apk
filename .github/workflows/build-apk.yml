#!/bin/bash

# Script mejorado para compilación de APK con soporte completo para AIDL
set -e

echo "=== Configurando entorno Android ==="

# Variables de entorno
export ANDROID_HOME=$PWD/android-sdk
export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
export PATH=$PATH:$ANDROID_HOME/platform-tools

# Crear directorios necesarios
mkdir -p $ANDROID_HOME/cmdline-tools

echo "=== Descargando Android SDK Command Line Tools ==="
wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
unzip -q commandlinetools-linux-9477386_latest.zip
mv cmdline-tools $ANDROID_HOME/cmdline-tools/latest

echo "=== Aceptando licencias automáticamente ==="
yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null 2>&1 || true

echo "=== Instalando componentes Android SDK ==="
# Instalar componentes esenciales
$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platform-tools"
$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-34"
$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-33"
$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "build-tools;34.0.0"
$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "build-tools;33.0.0"

echo "=== Configurando PATH para AIDL ==="
# Agregar múltiples versiones de build-tools al PATH
export PATH=$PATH:$ANDROID_HOME/build-tools/34.0.0
export PATH=$PATH:$ANDROID_HOME/build-tools/33.0.0

echo "=== Verificando instalación de AIDL ==="
# Verificar que AIDL esté disponible
AIDL_FOUND=false
for version in "34.0.0" "33.0.0"; do
    if [ -f "$ANDROID_HOME/build-tools/$version/aidl" ]; then
        echo "✓ AIDL encontrado en build-tools/$version"
        export AIDL_PATH="$ANDROID_HOME/build-tools/$version"
        AIDL_FOUND=true
        break
    fi
done

if [ "$AIDL_FOUND" = false ]; then
    echo "⚠️  AIDL no encontrado, intentando instalación alternativa..."
    # Intentar con versiones anteriores
    $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "build-tools;32.0.0"
    $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "build-tools;31.0.0"
    export PATH=$PATH:$ANDROID_HOME/build-tools/32.0.0
    export PATH=$PATH:$ANDROID_HOME/build-tools/31.0.0
fi

echo "=== Configurando permisos ==="
# Dar permisos de ejecución
chmod +x $ANDROID_HOME/build-tools/*/aidl 2>/dev/null || true
chmod +x $ANDROID_HOME/platform-tools/* 2>/dev/null || true

echo "=== Información del sistema ==="
echo "ANDROID_HOME: $ANDROID_HOME"
echo "PATH actualizado con build-tools"
which aidl || echo "AIDL command not found in PATH"
ls -la $ANDROID_HOME/build-tools/*/aidl 2>/dev/null || echo "No AIDL binary found"

echo "=== Preparando Gradle ==="
# Configurar Gradle Wrapper si no existe
if [ ! -f "gradlew" ]; then
    gradle wrapper
fi

# Dar permisos al script de Gradle
chmod +x gradlew

echo "=== Configurando gradle.properties para CI ==="
# Crear o actualizar gradle.properties
cat > gradle.properties << EOF
org.gradle.daemon=false
org.gradle.parallel=false
org.gradle.configureondemand=false
org.gradle.jvmargs=-Xmx2048m -XX:MaxMetaspaceSize=512m
android.useAndroidX=true
android.enableJetifier=true
EOF

echo "=== Limpiando proyecto ==="
./gradlew clean

echo "=== Compilando APK ==="
./gradlew assembleRelease --stacktrace --info

echo "=== Verificando APK generado ==="
find . -name "*.apk" -type f | head -5

echo "✅ Compilación completada exitosamente"
