#!/bin/bash

# Script completo para compilaciÃ³n de APK con AIDL totalmente configurado
set -e

echo "ðŸš€ === INICIANDO CONFIGURACIÃ“N COMPLETA ANDROID SDK CON AIDL ==="

# Variables de entorno principales
export ANDROID_HOME=$PWD/android-sdk
export ANDROID_SDK_ROOT=$ANDROID_HOME
export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
export PATH=$PATH:$ANDROID_HOME/platform-tools

# Limpiar instalaciones previas si existen
echo "ðŸ§¹ Limpiando instalaciones previas..."
rm -rf $ANDROID_HOME 2>/dev/null || true
rm -f commandlinetools-linux-*.zip 2>/dev/null || true

# Crear directorios necesarios
echo "ðŸ“ Creando estructura de directorios..."
mkdir -p $ANDROID_HOME/cmdline-tools
mkdir -p $ANDROID_HOME/platforms
mkdir -p $ANDROID_HOME/build-tools
mkdir -p $ANDROID_HOME/platform-tools

echo "â¬‡ï¸  === DESCARGANDO ANDROID SDK COMMAND LINE TOOLS ==="
wget -q --show-progress https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
echo "ðŸ“¦ Extrayendo Command Line Tools..."
unzip -q commandlinetools-linux-9477386_latest.zip
mv cmdline-tools $ANDROID_HOME/cmdline-tools/latest

# Verificar que sdkmanager estÃ© disponible
echo "ðŸ” Verificando sdkmanager..."
if [ ! -f "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" ]; then
    echo "âŒ Error: sdkmanager no encontrado"
    exit 1
fi

echo "âœ… sdkmanager encontrado correctamente"

echo "ðŸ“‹ === ACEPTANDO TODAS LAS LICENCIAS AUTOMÃTICAMENTE ==="
# Crear archivo de respuestas automÃ¡ticas para licencias
mkdir -p $ANDROID_HOME/licenses
echo -e "\n8933bad161af4178b1185d1a37fbf41ea5269c55" > $ANDROID_HOME/licenses/android-sdk-license
echo -e "\n84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_HOME/licenses/android-sdk-preview-license
echo -e "\nd975f751698a77b662f1254ddbeed3901e976f5a" > $ANDROID_HOME/licenses/intel-android-extra-license

# Aceptar licencias de forma interactiva tambiÃ©n
yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null 2>&1 || true

echo "ðŸ”§ === INSTALANDO COMPONENTES ANDROID SDK ==="
echo "Instalando platform-tools..."
$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platform-tools"

echo "Instalando platforms..."
$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-34"
$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-33"
$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-32"

echo "Instalando build-tools (incluyendo AIDL)..."
$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "build-tools;34.0.0"
$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "build-tools;33.0.2"
$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "build-tools;33.0.1"
$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "build-tools;33.0.0"
$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "build-tools;32.0.0"

echo "Instalando herramientas adicionales..."
$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "extras;android;m2repository"
$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "extras;google;m2repository"

echo "ðŸ› ï¸  === CONFIGURANDO PATH COMPLETO PARA AIDL ==="
# Agregar todas las versiones de build-tools al PATH
export PATH=$PATH:$ANDROID_HOME/build-tools/34.0.0
export PATH=$PATH:$ANDROID_HOME/build-tools/33.0.2
export PATH=$PATH:$ANDROID_HOME/build-tools/33.0.1
export PATH=$PATH:$ANDROID_HOME/build-tools/33.0.0
export PATH=$PATH:$ANDROID_HOME/build-tools/32.0.0

# Actualizar PATH permanentemente para el script
echo "export PATH=\$PATH:$ANDROID_HOME/build-tools/34.0.0" >> ~/.bashrc
echo "export PATH=\$PATH:$ANDROID_HOME/build-tools/33.0.2" >> ~/.bashrc
echo "export ANDROID_HOME=$ANDROID_HOME" >> ~/.bashrc

echo "ðŸ” === VERIFICACIÃ“N COMPLETA DE AIDL ==="
AIDL_FOUND=false
AIDL_VERSION=""

# Buscar AIDL en todas las versiones instaladas
for version in "34.0.0" "33.0.2" "33.0.1" "33.0.0" "32.0.0"; do
    AIDL_PATH="$ANDROID_HOME/build-tools/$version/aidl"
    if [ -f "$AIDL_PATH" ]; then
        echo "âœ… AIDL encontrado en build-tools/$version"
        echo "ðŸ“ Ruta: $AIDL_PATH"
        
        # Dar permisos de ejecuciÃ³n
        chmod +x "$AIDL_PATH"
        
        # Probar que funciona
        if "$AIDL_PATH" --help > /dev/null 2>&1; then
            echo "âœ… AIDL funciona correctamente en versiÃ³n $version"
            AIDL_FOUND=true
            AIDL_VERSION=$version
            export PREFERRED_AIDL_PATH="$ANDROID_HOME/build-tools/$version"
        else
            echo "âš ï¸  AIDL encontrado pero no funciona en versiÃ³n $version"
        fi
    else
        echo "âŒ AIDL no encontrado en build-tools/$version"
    fi
done

if [ "$AIDL_FOUND" = false ]; then
    echo "ðŸš¨ ERROR CRÃTICO: AIDL no encontrado en ninguna versiÃ³n"
    echo "Intentando instalaciÃ³n de emergencia..."
    
    # InstalaciÃ³n de emergencia con versiones mÃ¡s antiguas
    $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "build-tools;31.0.0"
    $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "build-tools;30.0.3"
    
    export PATH=$PATH:$ANDROID_HOME/build-tools/31.0.0
    export PATH=$PATH:$ANDROID_HOME/build-tools/30.0.3
    
    for version in "31.0.0" "30.0.3"; do
        if [ -f "$ANDROID_HOME/build-tools/$version/aidl" ]; then
            chmod +x "$ANDROID_HOME/build-tools/$version/aidl"
            echo "âœ… AIDL de emergencia encontrado en $version"
            AIDL_FOUND=true
            AIDL_VERSION=$version
            break
        fi
    done
fi

if [ "$AIDL_FOUND" = false ]; then
    echo "ðŸ’¥ FALLO TOTAL: No se pudo instalar AIDL"
    exit 1
fi

echo "ðŸ”§ === CONFIGURANDO PERMISOS COMPLETOS ==="
# Dar permisos a todos los ejecutables
find $ANDROID_HOME/build-tools -name "*" -type f -exec chmod +x {} \; 2>/dev/null || true
find $ANDROID_HOME/platform-tools -name "*" -type f -exec chmod +x {} \; 2>/dev/null || true

echo "ðŸ“Š === INFORMACIÃ“N COMPLETA DEL SISTEMA ==="
echo "ðŸ  ANDROID_HOME: $ANDROID_HOME"
echo "ðŸ—ï¸  ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
echo "ðŸŽ¯ AIDL preferido: $PREFERRED_AIDL_PATH/aidl"
echo "ðŸ“¦ VersiÃ³n AIDL activa: $AIDL_VERSION"

echo ""
echo "ðŸ“‹ Componentes instalados:"
$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list_installed | grep -E "(build-tools|platform)"

echo ""
echo "ðŸ” VerificaciÃ³n de comandos:"
which aidl && echo "âœ… aidl disponible en PATH" || echo "âš ï¸  aidl no estÃ¡ en PATH"
echo "ðŸ”§ Ubicaciones de AIDL:"
find $ANDROID_HOME -name "aidl" -type f -exec ls -la {} \; 2>/dev/null || echo "No se encontraron archivos aidl"

echo ""
echo "ðŸ§ª === PRUEBA DE FUNCIONAMIENTO AIDL ==="
if [ -f "$PREFERRED_AIDL_PATH/aidl" ]; then
    echo "Probando AIDL..."
    "$PREFERRED_AIDL_PATH/aidl" --help && echo "âœ… AIDL responde correctamente" || echo "âŒ AIDL no responde"
fi

echo "ðŸ—ï¸  === CONFIGURACIÃ“N DE GRADLE ==="
# Setup de Java si no estÃ¡ configurado
if [ -z "$JAVA_HOME" ]; then
    export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
    echo "â˜• JAVA_HOME configurado: $JAVA_HOME"
fi

# Configurar Gradle Wrapper si no existe
if [ ! -f "gradlew" ]; then
    echo "ðŸ“¦ Inicializando Gradle Wrapper..."
    gradle wrapper --gradle-version=8.0
fi

# Dar permisos al script de Gradle
chmod +x gradlew

echo "âš™ï¸  === CREANDO CONFIGURACIÃ“N GRADLE OPTIMIZADA ==="
# Crear gradle.properties optimizado para CI
cat > gradle.properties << EOF
# ConfiguraciÃ³n optimizada para CI/CD
org.gradle.daemon=false
org.gradle.parallel=true
org.gradle.configureondemand=false
org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError
org.gradle.caching=true

# Android especÃ­fico
android.useAndroidX=true
android.enableJetifier=true
android.enableBuildCache=true
android.enableR8.fullMode=true

# Build especÃ­fico
android.builder.sdkDownload=false
android.experimental.enableSourceSetPathsMap=true
EOF

echo "ðŸ§¹ === LIMPIEZA DE PROYECTO ==="
echo "Limpiando proyecto anterior..."
./gradlew clean --stacktrace

echo "ðŸ”¨ === COMPILANDO APK ==="
echo "Iniciando compilaciÃ³n con informaciÃ³n detallada..."
./gradlew assembleRelease --stacktrace --info --debug

echo "ðŸ” === VERIFICANDO RESULTADOS ==="
echo "ðŸ“± APKs generados:"
find . -name "*.apk" -type f -exec ls -lh {} \;

echo ""
echo "ðŸ“ Ubicaciones de archivos:"
find . -name "*.apk" -type f | head -10

echo ""
echo "âœ… === COMPILACIÃ“N COMPLETADA EXITOSAMENTE ==="
echo "ðŸŽ‰ AIDL instalado y funcionando en versiÃ³n: $AIDL_VERSION"
echo "ðŸ“± APK listo para deployment"

# Crear reporte final
cat > build_report.txt << EOF
=== REPORTE DE COMPILACIÃ“N ===
Fecha: $(date)
ANDROID_HOME: $ANDROID_HOME
AIDL VersiÃ³n: $AIDL_VERSION
AIDL Path: $PREFERRED_AIDL_PATH/aidl
APKs generados: $(find . -name "*.apk" -type f | wc -l)

Componentes instalados:
$($ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list_installed | grep -E "(build-tools|platform)")
EOF

echo "ðŸ“„ Reporte guardado en: build_report.txt"
echo "ðŸ Â¡SCRIPT COMPLETADO CON Ã‰XITO!"
